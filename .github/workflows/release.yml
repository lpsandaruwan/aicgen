name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write

jobs:
  # ----------------------------------------------------------------
  # JOB: BUILD WINDOWS
  # ----------------------------------------------------------------
  release-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          
      - uses: oven-sh/setup-bun@v1
      
      - name: Build Windows Binary
        run: |
          bun install
          bun run build:binary:windows
          
      - name: Setup NSIS
        run: |
          choco install nsis
          echo "C:\Program Files (x86)\NSIS" >> $env:GITHUB_PATH
          
          # Install EnVar Plugin
          Invoke-WebRequest -Uri "https://github.com/GsNSIS/EnVar/releases/download/v0.3.1/EnVar-Plugin.zip" -OutFile "envar.zip"
          Expand-Archive "envar.zip" -DestinationPath "envar_temp"
          Copy-Item "envar_temp\Plugins\x86-unicode\EnVar.dll" "C:\Program Files (x86)\NSIS\Plugins\x86-unicode\EnVar.dll"

      - name: Create Installer (NSIS)
        run: |
          makensis packaging/windows/setup.nsi
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: dist/aicgen-setup-x64.exe

  # ----------------------------------------------------------------
  # JOB: BUILD LINUX
  # ----------------------------------------------------------------
  release-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: oven-sh/setup-bun@v1
      
      - name: Build Linux Binary
        run: |
          bun install
          bun run build:binary:linux
          
      - name: Create Deb Package
        run: |
          mkdir -p dist/deb/usr/bin
          cp dist/aicgen-linux dist/deb/usr/bin/aicgen
          chmod +x dist/deb/usr/bin/aicgen
          
          mkdir -p dist/deb/DEBIAN
          cp packaging/linux/control dist/deb/DEBIAN/control
          
          dpkg-deb --build dist/deb dist/aicgen_amd64.deb

      - name: Create RPM Package
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm
          
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          cp dist/aicgen-linux ~/rpmbuild/SOURCES/
          cp packaging/linux/aicgen.spec ~/rpmbuild/SPECS/
          
          rpmbuild -ba ~/rpmbuild/SPECS/aicgen.spec
          cp ~/rpmbuild/RPMS/x86_64/*.rpm dist/aicgen_x86_64.rpm
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-package
          path: |
            dist/aicgen_amd64.deb
            dist/aicgen_x86_64.rpm

  # ----------------------------------------------------------------
  # JOB: BUILD MACOS
  # ----------------------------------------------------------------
  release-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: oven-sh/setup-bun@v1
      
      - name: Build macOS Binary
        run: |
          bun install
          bun run build:binary:macos
          
      - name: Create PKG Installer
        run: |
          # Structure
          mkdir -p dist/pkg/usr/local/bin
          cp dist/aicgen-macos dist/pkg/usr/local/bin/aicgen
          chmod +x dist/pkg/usr/local/bin/aicgen
  # ----------------------------------------------------------------
  publish-npm:
    needs: [release-windows, release-linux, release-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: oven-sh/setup-bun@v1
  
      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Build and Publish
        run: |
          bun install
          bun run build
          npm publish --provenance --access public

  # ----------------------------------------------------------------
  # JOB: PUBLISH RELEASE
  # ----------------------------------------------------------------
  publish-release:
    needs: [release-windows, release-linux, release-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            windows-installer/aicgen-setup-x64.exe
            linux-package/aicgen_amd64.deb
            linux-package/aicgen_x86_64.rpm
            macos-installer/aicgen.pkg
          draft: false
          prerelease: false
          generate_release_notes: true
